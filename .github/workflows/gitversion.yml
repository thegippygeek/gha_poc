name: GitVersion

on:
  workflow_call:
    outputs:
      GitVersion_BranchName:
        description: "The Branch Name from GitVersion"
        value: ${{jobs.get_GitVersion.outputs.GitVersion_BranchName}}
      GitVersion_FullSemVer:
        description: "The Full Semver generated by GitVersion"
        value: ${{jobs.get_GitVersion.outputs.GitVersion_FullSemVer}}
      GitVersion_ShortSHA:
        description: "The ShortSHA from GitVersion"
        value: ${{jobs.get_GitVersion.outputs.GitVersion_ShortSHA}}
      GitVersion_MajorMinorPatch:
        description: "The Major.Minor.Patch version from GitVersion"
        value: ${{jobs.get_GitVersion.outputs.GitVersion_MajorMinorPatch}}        
jobs:
  get_GitVersion:
    runs-on: ubuntu-latest
    outputs: 
        GitVersion_BranchName:      ${{steps.version_step.outputs.GitVersion_BranchName}}
        GitVersion_FullSemVer:      ${{steps.version_step.outputs.GitVersion_FullSemVer}}
        GitVersion_ShortSHA:        ${{steps.version_step.outputs.GitVersion_ShortSHA}}
        GitVersion_MajorMinorPatch: ${{steps.version_step.outputs.GitVersion_MajorMinorPatch}}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
            fetch-depth: 0

      # docker run --rm -v "$(pwd):/repo" gittools/gitversion:{tag} /repo
      - name: GitVersion | Container Run
        uses: addnab/docker-run-action@v3
        with:
          registry: docker.io
          image: gittools/gitversion:latest
          options: -v ${{github.workspace}}:/repo --env GITHUB_ACTIONS=true --env GITHUB_ENV=/repo/vars.env --env GITHUB_REF=${{github.base_ref}}
          run: /tools/dotnet-gitversion /repo /output buildserver /config /repo/AWS-GitVersion.yml

      - name: GitVersion | set to host env vars from vars.env
        run: |
          while read -r line; do var="$line"; 
            echo "$line" >> $GITHUB_ENV
          done < ${{github.workspace}}/vars.env
          
      - name: GitVersion | set GHA Outputs
        id: version_step
        run: |
          while read -r line; do var="$line"; 
            echo "$line" >> $GITHUB_OUTPUT
          done < ${{github.workspace}}/vars.env

      - name: GitVersion | Output GitVersion Values
        run: cat ${{github.workspace}}/vars.env

      - name: Display GitVersion variables (with prefix)
        run:  |
          echo "FullSemVer (env.GitVersion_FullSemVer) : ${{ env.GitVersion_FullSemVer }}"

      - name: Display GitVersion outputs (step output with prefix)
        run: |
          echo "FullSemVer (steps.version_step.outputs.GitVersion_FullSemVer) : ${{ steps.version_step.outputs.GitVersion_FullSemVer }}"

      - name: Generate List of Variables for Summary
        run: | 
          echo "### GitVersion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          while read -r line; do var="$line";
            echo "- $line" >> $GITHUB_STEP_SUMMARY
          done < ${{ github.workspace }}/vars.env  
